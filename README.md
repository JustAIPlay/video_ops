# 大航海运营助手 (Video Ops Assistant)

这是一个专为视频号运营团队设计的现代化数据同步与排期规划仪表盘。它能够连接本地运行的大航海 API 服务，获取视频发布统计数据，自动同步到飞书多维表格（Feishu Base），并提供智能化的视频排期建议功能和每日复盘会议功能。

界面采用了 **Modern Soft-Neo UI** 设计风格，提供柔和、流畅且专业的交互体验。

## ✨ 主要功能

### 双模式运行

*   **传统模式**：经典的数据同步与排期规划功能，保持原有操作习惯。
*   **AI 智能模式**：基于三层 AI 分析架构，提供内容质量评分、优化建议和病毒指数预测。

### 每日复盘会议 (Daily Review) 🆕

*   **智能会议系统**：模拟真实的三人复盘会议流程
    *   **数据分析专员 (Analyst)**：分析当日数据概览、Top 表现视频、数据洞察
    *   **排期策略专家 (Strategist)**：评估策略执行、时段效果分析、明日排期建议
    *   **增长黑客 (Hacker)**：发现异常案例、生成实验假设、提出 A/B 测试建议
*   **实时流式输出**：采用 SSE (Server-Sent Events) 技术，模拟真人发言节奏
*   **交互式提问**：支持 @Agent 提问，获取针对性的分析和建议
*   **可执行操作项**：自动生成可执行的操作建议（添加排期、创建实验等）
*   **日期选择**：支持选择任意历史日期进行复盘，默认复盘前一天的数据
*   **数据来源**：从飞书多维表格自动获取指定日期发布的视频数据
*   **会议总结**：自动生成关键洞察、行动项和实验假设
*   **自定义提示词**：支持在系统设置中配置各 Agent 的 System Prompt，灵活调整分析策略

### AI 智能分析系统

*   **三层分析架构**：
    *   **第一层（视频内容层）**：分析单个视频的内容质量、发布时机、账号匹配度，提供 S/A/B/C 评级和优化建议
    *   **第二层（账号/分组层）**：分析账号表现、分组对比、账号协同建议（开发中）
    *   **第三层（全局运营层）**：矩阵健康度分析、资源分配建议、增长趋势预测（开发中）
*   **AI 智能洞察**：在数据同步过程中自动触发 AI 分析，实时显示分析进度和结果
*   **智能评分系统**：综合评分（1-10分）、维度评分（内容质量/时机/账号匹配）、病毒传播指数（0-100）
*   **AI 诊断终端**：在 AI 模式下同步时，显示实时分析进度和 AI 思考过程

### 数据同步核心 (Data Sync)

*   从本地 API (`http://127.0.0.1:9802`) 拉取视频号统计数据。
*   **智能去重 (Smart Upsert)**：
    *   **三重精准匹配**：采用「账号名称 + 分钟级发布时间 + 内容描述」联合主键匹配策略。
    *   只有当这三者完全一致时，才判定为旧数据并执行更新（仅刷新统计数据）。
    *   若其中任意一项不匹配（例如人工修改了飞书中的内容描述），系统将视为新视频进行插入，防止错误覆盖。
*   **字段保护策略**：更新已有记录时，自动保护"内容描述"等人工维护字段不被覆盖；新增记录时则写入全量信息。
*   **智能搜索**：支持直接输入**中文账号名称**进行搜索同步，系统会自动处理模糊匹配。
*   **批量查重优化**：同步前自动预读取飞书已有记录，大幅减少 API 调用次数。

### 发布排期规划 (Schedule Planning)

*   **智能筛选逻辑 (按分组策略)**：
    *   **1. 全局基础门槛 (Universal Rules)**：
        *   所有进入排期池的视频，必须同时满足以下两个硬性条件，否则直接被过滤掉：
        *   **浏览量门槛**：`浏览次数 (readCount) >= 1000`（只保留有一定热度的数据）。
        *   **疲劳度控制**：`重复次数 (repeatCount) < 3`（该视频编号在当前分组的历史数据中出现的次数必须少于 3 次）。
    *   **2. 分组白名单 (Allowed Groups)**：
        *   系统目前仅处理包含以下关键字的分组：`ai绿植`、`图书`、`汽车`、`家清`、`百货`。
    *   **3. 分组差异化策略 (Differentiation Strategy)**：
        *   **后端逻辑**: 仅负责上述"基础门槛"的筛选，**不再进行任何强制去重**。所有符合条件的数据都会返回给前端。
        *   **前端交互**: 提供"展示模式"开关，用户可自由切换：
            *   **全部展示 (All Mode)**: 展示所有后端返回的数据，即使同一视频编号出现多次（适用于查看历史详情）。
            *   **去重展示 (Unique Mode)**: 系统在前端进行实时去重，按 `(分组名 + 视频编号)` 为唯一键，只保留**浏览量最高**的那一条（适用于制作排期表）。
    *   **4. 排序规则 (Sorting)**：
        *   最终输出的列表，统一按照 **浏览量 (readCount) 从高到低** 排序。
    *   **实时计算**：动态计算每个视频所属账号在**今日**的已发布数量。

*   **可视化排期表**：
    *   **列表展示**：按浏览量倒序展示建议排期的视频列表，支持按分组筛选查看。
    *   **多维筛选**：
        *   **分组筛选**：查看特定品类/分组的视频。
        *   **账号筛选**：支持通过下拉菜单或**模糊搜索**快速定位特定账号，支持与分组筛选联动（仅显示当前分组下的账号）。
        *   **去重展示**：一键切换全部数据或去重后的精简数据。
    *   **关键指标**：
        *   **账号**：展示视频所属的账号名称。
        *   **历史发布次数**：展示该视频在组内的累计发布次数。
        *   **账号今日发布次数**：展示该账号今日已发视频数。**若今日已有发布（>0），该数字将高亮显示（橙色），提示运营注意频控。**
    *   **数据统计**：实时显示筛选通过率及被拒绝的原因（浏览量不足或重复过多）。
    *   **AI 智能洞察面板**：在 AI 模式下，右侧展示 AI 分析结果，包括评分、建议和推理过程。

### 灵活的路由策略

*   支持将不同的视频号账号映射到飞书云文档中 **不同的 Base（多维表格）** 和 **数据表 (Table)**。
*   支持识别 **Wiki Token** 与 **Base Token**，配置更智能。

### 可视化控制台

*   实时滚动的日志控制台，显示同步进度、新增/更新条数、筛选统计及错误信息。
*   **UI 风格统一**：所有模块（同步、配置、排期）均采用一致的大圆角卡片与渐变流光设计。

## 🛠️ 技术栈

### 前端
*   **前端框架**: React 19
*   **构建工具**: Vite 6
*   **语言**: TypeScript
*   **样式库**: Tailwind CSS
*   **图标库**: Lucide React
*   **状态管理**: React Context API
*   **UI 风格**: Soft-Neo (柔和渐变、悬浮卡片、大圆角、动态流光按钮)

### 后端
*   **Web 框架**: FastAPI
*   **AI 引擎**: OpenAI 兼容 API (支持 Kimi、ChatGPT 等)
*   **数据处理**: Pydantic
*   **异步支持**: asyncio/uvicorn
*   **Agent 架构**: 三层智能分析系统

## 🚀 快速开始

### 1. 环境准备

确保您的本地环境中已安装 Node.js 和 Python 3.8+。

### 2. 安装依赖

**前端：**
```bash
npm install
# 或者
yarn install
```

**后端：**
```bash
cd backend
pip install -r requirements.txt
```

### 3. 配置环境变量

在 `backend/.env` 文件中配置相关服务：

```env
# ================== LLM API 配置 ==================
OPENAI_API_KEY=your_api_key_here
OPENAI_BASE_URL=https://api.moonshot.cn/v1
OPENAI_MODEL_NAME=moonshot-v1-8k

# ================== 飞书 API 配置 ==================
# 飞书应用凭证
LARK_APP_ID=your_app_id
LARK_APP_SECRET=your_app_secret

# 每日复盘功能 - 飞书表格配置
# 从飞书表格 URL 获取：https://xxx.feishu.cn/base/TOKEN/app/TABLEID
FEISHU_BASE_TOKEN=your_base_token
FEISHU_TABLE_ID=your_table_id

# ================== 后端服务配置 ==================
BACKEND_HOST=0.0.0.0
BACKEND_PORT=8000
```

### 4. 启动项目

**启动后端服务：**
```bash
cd backend
python -m uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

**启动前端服务：**
```bash
npm run dev
```

*   前端默认运行在 `http://localhost:3000`
*   后端 API 运行在 `http://localhost:8000`
*   API 文档访问：`http://localhost:8000/docs`

### 5. 本地数据服务 (依赖项)

本项目依赖本地运行的大航海数据服务来获取视频数据。
*   **接口地址**: `http://127.0.0.1:9802`
*   **基础路径**: `/sph/api`

## ⚙️ 配置指南

在使用功能前，请先进入 **「系统配置」** 页面进行设置。

### 1. 凭证设置
输入您的飞书应用凭证（用于调用飞书 Open API）：
*   **App ID**
*   **App Secret**

### 2. 路由策略 (Routing Strategy)
定义大航海账号数据流向哪个飞书表格。
*   **视频号用户/分组名**: 必须与 API 返回的 `username` 完全一致（例如：`运营大号_A`）或与排期分组名一致（例如：`ai绿植`、`图书`、`汽车`、`家清`、`百货`）。
*   **Base Token**: 飞书多维表格 URL 中的标识符（支持 Wiki URL Token 自动解析）。
*   **Table ID**: 数据表的唯一 ID。

### 3. Agent 提示词配置 🆕
自定义每日复盘会议中各 Agent 的 System Prompt，灵活调整分析策略：
*   **数据分析 Agent (📊)**：负责数据概览、Top 表现、数据洞察分析
*   **排期策略 Agent (🎯)**：负责策略评估、时段分析、排期建议
*   **增长黑客 Agent (🚀)**：负责异常发现、假设生成、实验建议
*   **总结 Agent (📝)**：负责整合观点、生成结构化总结

**配置说明**：
*   系统已预填充默认提示词，可直接使用
*   点击 Agent 卡片展开编辑区域
*   支持手动调整输入框大小
*   修改后需点击"保存更改"生效
*   核心三个 Agent 提示词不能为空（总结 Agent 可选）

### 4. AI 模式配置

在 `backend/.env` 中配置 AI 提供商：
*   **Kimi (Moonshot)**: `https://api.moonshot.cn/v1`
*   **OpenAI**: `https://api.openai.com/v1`
*   **DeepSeek**: `https://api.deepseek.com/v1` (支持 R1 推理模型)
*   **其他兼容服务**: 任何支持 OpenAI API 格式的服务

## 📊 同步字段说明

系统会将以下字段同步至飞书多维表格，请确保您的表格中包含相应列（**列名必须完全一致**）：

| 飞书字段名 | 说明 | 备注 |
| :--- | :--- | :--- |
| **账号** | 视频号名称 | 必填，主键之一 |
| **发布时间** | 视频发布日期 | 必填，主键之一 (时间戳) |
| **浏览次数** | readCount | |
| **推荐次数** | favCount | |
| **评论次数** | commentCount | |
| **分享次数** | forwardCount | |
| **转发聊天和朋友圈** | forwardAggregationCount | |
| **喜欢次数** | likeCount | |
| **完播率** | fullPlayRate | 自动解析百分比 |
| **平均播放时长** | avgPlayTimeSec | 自动解析数字 |
| **内容描述** | video.name | 对应大航海"动态信息"，主键之一 |
| **视频编号** | (排期用) | 需在飞书中配置捷径生成 |
| **AI 评分** | 综合评分 (1-10) | AI 分析结果 |
| **AI 建议** | 优化建议 | AI 分析结果 |
| **病毒指数** | 传播指数 (0-100) | AI 分析结果 |

## 🎨 设计理念

本项目遵循 **Modern Soft-Neo UI** 设计规范：
*   **传统模式色调**: 以柔紫色 (#8C7CF0) 为主色，搭配浅灰白背景 (#FDFBFF) 与渐变装饰
*   **AI 模式色调**: 以靛蓝色 (#6366F1) 为主色，搭配极简白背景 (#F8FAFC) 与科技感装饰
*   **布局**: 响应式三栏/两栏布局，强调内容的层级与呼吸感
*   **版本**: v2.0.0 (AI Enhanced)

## 📁 项目结构

```
video_ops/
├── backend/                 # 后端服务
│   ├── main.py             # FastAPI 主入口
│   ├── models/             # 数据模型
│   ├── prompts/            # AI 提示词模板
│   └── services/
│       ├── agents/         # AI 分析 Agents
│       │   ├── base_agent.py
│       │   ├── content_agent.py
│       │   ├── account_agent.py
│       │   └── global_agent.py
│       └── matrix_agent.py # 传统矩阵分析
├── components/             # React 组件
│   ├── Layout.tsx
│   ├── SyncView.tsx
│   ├── ScheduleView.tsx
│   ├── ModeSwitcher.tsx   # 模式切换器
│   └── ...
├── contexts/              # 全局状态
│   └── AppContext.tsx     # App 状态管理
├── services/              # API 服务
│   └── aiAnalysisService.ts
├── styles/                # 样式文件
│   └── theme-ai.css       # AI 模式主题
└── package.json
```

## 🚧 开发计划

### Phase 3 - 每日复盘会议
- [x] 每日复盘会议 UI 界面
- [x] 三人 Agent 系统（数据分析师/策略专家/增长黑客）
- [x] SSE 流式输出模拟发言
- [x] 交互式提问功能
- [x] 飞书数据集成（按日期筛选）
- [x] 会议总结生成
- [x] Agent 提示词自定义配置
- [ ] 可执行操作项对接排期系统
- [ ] 历史复盘记录存储

### AI 智能分析系统
- [x] 双模式切换系统
- [x] AI 诊断终端 UI
- [x] 视频内容层分析 Agent
- [ ] 账号/分组层分析 Agent
- [ ] 全局运营层分析 Agent
- [ ] 飞书写入 AI 分析结果
- [ ] 智能洞察可视化页面
- [ ] 三层协调器 (Coordinator)

---
© 2024 Video Ops Assistant. Designed for efficiency.
